"""\nLIVING ENVIRONMENT ENGINE - INTEGRATION TESTS\nComprehensive test suite for LEE components.\n\nRun with: pytest tests/test_lee_integration.py -v\n"""\n\nimport pytest\nfrom datetime import datetime, timezone, timedelta\nimport math\n\nfrom core.environment import (\n    LivingEnvironmentEngine,\n    EnvironmentState,\n    TimePhase,\n    Season,\n    WeatherCondition,\n    AlchemicalStage,\n)\nfrom core.environment.astronomy import AstronomyCalculator\nfrom core.environment.weather import OpenWeatherMapClient, WeatherData\n\n# ---------------------------------------------------------------------------\n# Fixtures\n# ---------------------------------------------------------------------------\n\n@pytest.fixture\ndef engine():\n    \"\"\"Create LEE instance without API key (fallback weather).\"\"\"\n    return LivingEnvironmentEngine(weather_api_key=None)\n\n@pytest.fixture\ndef astronomy():\n    \"\"\"Create astronomy calculator.\"\"\"\n    return AstronomyCalculator()\n\n# ---------------------------------------------------------------------------\n# Engine Tests\n# ---------------------------------------------------------------------------\n\ndef test_engine_initialization(engine):\n    \"\"\"Test engine initializes correctly.\"\"\"\n    assert engine is not None\n    assert engine.astronomy is not None\n    assert engine.weather_client is not None\n    assert engine.z_stream is not None\n\ndef test_get_state_san_antonio(engine):\n    \"\"\"Test state generation for San Antonio, TX.\"\"\"\n    state = engine.get_state(lat=29.4241, lon=-98.4936)\n    \n    assert isinstance(state, EnvironmentState)\n    assert state.timestamp is not None\n    assert isinstance(state.time_of_day, TimePhase)\n    assert isinstance(state.season, Season)\n    assert isinstance(state.condition, WeatherCondition)\n    assert 0 <= state.z_score <= 12\n    assert state.sky_color is not None\n\ndef test_crisis_override(engine):\n    \"\"\"Test Z<2 crisis override.\"\"\"\n    # Force crisis state\n    engine.z_stream.update(coherence=0.1, fidelity=0.1, balance=0.1)\n    state = engine.get_state(lat=29.4241, lon=-98.4936)\n    \n    assert state.z_score < 2.0\n    assert state.z_override is True\n    assert state.alchemical_stage == AlchemicalStage.CRISIS\n    assert state.light_intensity <= 0.3\n    assert state.tree_luminosity < 0.2\n    assert state.fire_intensity > 0.8\n\ndef test_transcendent_override(engine):\n    \"\"\"Test Z>=10 transcendent state.\"\"\"\n    # Force transcendent state\n    engine.z_stream.update(coherence=0.95, fidelity=0.95, balance=0.95)\n    state = engine.get_state(lat=29.4241, lon=-98.4936)\n    \n    assert state.z_score >= 10.0\n    assert state.z_override is True\n    assert state.alchemical_stage == AlchemicalStage.TRANSCENDENT\n    assert state.tree_luminosity == 1.0\n\n# ---------------------------------------------------------------------------\n# Astronomy Tests\n# ---------------------------------------------------------------------------\n\ndef test_solar_position_noon(astronomy):\n    \"\"\"Test solar position at solar noon.\"\"\"\n    dt = datetime(2026, 6, 21, 18, 0, tzinfo=timezone.utc)  # June solstice, noon CST\n    pos = astronomy.solar_position(lat=29.4241, lon=-98.4936, dt=dt)\n    \n    assert \"altitude\" in pos\n    assert \"azimuth\" in pos\n    assert pos[\"altitude\"] > 60  # High sun in summer\n    assert isinstance(pos[\"phase\"], TimePhase)\n\ndef test_seasonal_transitions(astronomy):\n    \"\"\"Test season calculation for northern hemisphere.\"\"\"\n    # Spring\n    spring = astronomy.season(lat=40.0, dt=datetime(2026, 4, 15))\n    assert spring == Season.SPRING\n    \n    # Summer\n    summer = astronomy.season(lat=40.0, dt=datetime(2026, 7, 15))\n    assert summer == Season.SUMMER\n    \n    # Autumn\n    autumn = astronomy.season(lat=40.0, dt=datetime(2026, 10, 15))\n    assert autumn == Season.AUTUMN\n    \n    # Winter\n    winter = astronomy.season(lat=40.0, dt=datetime(2026, 1, 15))\n    assert winter == Season.WINTER\n\ndef test_hemisphere_reversal(astronomy):\n    \"\"\"Test seasons reverse in southern hemisphere.\"\"\"\n    dt = datetime(2026, 7, 15)  # July\n    \n    north = astronomy.season(lat=40.0, dt=dt)\n    south = astronomy.season(lat=-40.0, dt=dt)\n    \n    assert north == Season.SUMMER\n    assert south == Season.WINTER\n\ndef test_tropical_wet_dry_seasons(astronomy):\n    \"\"\"Test tropical regions use wet/dry instead of four seasons.\"\"\"\n    # Within 23.5Â° of equator\n    wet = astronomy.season(lat=10.0, dt=datetime(2026, 7, 15))  # July = wet\n    dry = astronomy.season(lat=10.0, dt=datetime(2026, 1, 15))  # January = dry\n    \n    assert wet == Season.WET\n    assert dry == Season.DRY\n\n# ---------------------------------------------------------------------------\n# Time Phase Tests\n# ---------------------------------------------------------------------------\n\ndef test_time_phases(astronomy):\n    \"\"\"Test time phase classification throughout day.\"\"\"\n    # Dawn\n    dawn = astronomy.solar_position(29.4241, -98.4936,\n                                     datetime(2026, 3, 1, 12, 30, tzinfo=timezone.utc))\n    # Note: times are approximate, actual depends on season\n    \n    # Should cover various phases throughout the day\n    phases_seen = set()\n    for hour in range(0, 24, 2):\n        dt = datetime(2026, 3, 1, hour, 0, tzinfo=timezone.utc)\n        pos = astronomy.solar_position(29.4241, -98.4936, dt)\n        phases_seen.add(pos[\"phase\"])\n    \n    # Should see at least 4 different phases in 24 hours\n    assert len(phases_seen) >= 4\n\n# ---------------------------------------------------------------------------\n# State Serialization Tests\n# ---------------------------------------------------------------------------\n\ndef test_state_serialization(engine):\n    \"\"\"Test EnvironmentState can be serialized to JSON.\"\"\"\n    state = engine.get_state(lat=29.4241, lon=-98.4936)\n    data = state.to_dict()\n    \n    assert isinstance(data, dict)\n    assert \"timestamp\" in data\n    assert \"time_of_day\" in data\n    assert \"z_score\" in data\n    assert \"sky_color\" in data\n    assert isinstance(data[\"sky_color\"], dict)\n    assert \"top\" in data[\"sky_color\"]\n    assert \"bottom\" in data[\"sky_color\"]\n\n# ---------------------------------------------------------------------------\n# Weather Tests\n# ---------------------------------------------------------------------------\n\ndef test_weather_fallback():\n    \"\"\"Test weather client falls back to CLEAR when no API key.\"\"\"\n    client = OpenWeatherMapClient(api_key=None)\n    weather = client.current(lat=29.4241, lon=-98.4936)\n    \n    assert isinstance(weather, WeatherData)\n    assert weather.condition == WeatherCondition.CLEAR\n    assert weather.temperature_c == 20.0\n\ndef test_weather_api_caching():\n    \"\"\"Test weather results are cached.\"\"\"\n    client = OpenWeatherMapClient(api_key=None, update_interval_seconds=60)\n    \n    # First call\n    w1 = client.current(lat=29.4241, lon=-98.4936)\n    \n    # Second call (should be cached)\n    w2 = client.current(lat=29.4241, lon=-98.4936)\n    \n    # Should be same object\n    assert w1 is w2\n\n# ---------------------------------------------------------------------------\n# Run Tests\n# ---------------------------------------------------------------------------\n\nif __name__ == \"__main__\":\n    pytest.main([__file__, \"-v\"])\n