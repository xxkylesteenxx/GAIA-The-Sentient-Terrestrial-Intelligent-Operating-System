"""\nLIVING ENVIRONMENT ENGINE - STATE REPRESENTATION\nEnvironmentState dataclass that derives all rendering parameters.\n\nEvidence Grade: E3 (Derived from E5 inputs, system integration)\n"""\n\nfrom __future__ import annotations\nfrom dataclasses import dataclass, field, asdict\nfrom datetime import datetime\nfrom typing import Optional\n\nfrom core.environment.types import (\n    TimePhase,\n    Season,\n    WeatherCondition,\n    AlchemicalStage,\n    SoundscapeID,\n    ParticleEffect,\n)\n\n# ---------------------------------------------------------------------------\n# RGB Gradient\n# ---------------------------------------------------------------------------\n\n@dataclass\nclass RGBGradient:\n    \"\"\"Two-color gradient for sky rendering.\"\"\"\n    top: str      # Hex color for zenith\n    bottom: str   # Hex color for horizon\n\n# ---------------------------------------------------------------------------\n# Environment State\n# ---------------------------------------------------------------------------\n\n@dataclass\nclass EnvironmentState:\n    \"\"\"\n    Complete snapshot of environmental state at a given moment.\n    \n    Combines four simultaneous data streams:\n    1. Astronomical cycles (solar position)\n    2. Seasonal transformation (GPS-based)\n    3. Live weather (OpenWeatherMap)\n    4. Z-score override (crisis detection)\n    \n    All rendering parameters are derived from these inputs.\n    \"\"\"\n    \n    # Core inputs (E5 evidence)\n    timestamp: datetime\n    time_of_day: TimePhase\n    solar_angle: float      # Altitude in degrees\n    season: Season\n    condition: WeatherCondition\n    \n    # Z-score (from Core plane)\n    z_score: float\n    z_override: bool = False  # True when Z forces environment change\n    \n    # Environmental metrics (E5)\n    temperature_c: float = 20.0\n    humidity: float = 0.5\n    wind_speed_ms: float = 2.0\n    uv_index: float = 5.0\n    \n    # Derived rendering parameters (E3)\n    sky_color: Optional[RGBGradient] = None\n    light_intensity: float = 0.8\n    fog_density: float = 0.0\n    ambient_sound: SoundscapeID = SoundscapeID.SILENCE\n    particle_type: ParticleEffect = ParticleEffect.NONE\n    \n    # Z-score reactive (E3)\n    tree_luminosity: float = 0.0  # Yggdrasil glow (male home)\n    fire_intensity: float = 0.5   # Sacred fire (female home)\n    alchemical_stage: AlchemicalStage = AlchemicalStage.CITRINITAS\n    \n    def __post_init__(self):\n        \"\"\"Derive all rendering parameters from core inputs.\"\"\"\n        self.derive_rendering_params()\n    \n    def derive_rendering_params(self) -> None:\n        \"\"\"\n        Calculate all rendering parameters from core state.\n        \n        This is where the magic happens - environmental meaning emerges\n        from the interplay of astronomy, weather, season, and Z-score.\n        \"\"\"\n        # 1. Z-score interpretation\n        self._derive_z_stage()\n        self._derive_z_reactivity()\n        \n        # 2. Sky color (time + weather)\n        self._derive_sky_color()\n        \n        # 3. Lighting (sun + weather + Z)\n        self._derive_light_intensity()\n        \n        # 4. Atmospheric effects\n        self._derive_fog_density()\n        self._derive_particle_effects()\n        \n        # 5. Soundscape\n        self._derive_ambient_sound()\n    \n    def _derive_z_stage(self) -> None:\n        \"\"\"Map Z-score to alchemical stage.\"\"\"\n        z = self.z_score\n        \n        if z < 2:\n            self.alchemical_stage = AlchemicalStage.CRISIS\n        elif z < 4:\n            self.alchemical_stage = AlchemicalStage.NIGREDO\n        elif z < 6:\n            self.alchemical_stage = AlchemicalStage.ALBEDO\n        elif z < 8:\n            self.alchemical_stage = AlchemicalStage.CITRINITAS\n        elif z < 9:\n            self.alchemical_stage = AlchemicalStage.RUBEDO\n        elif z < 10:\n            self.alchemical_stage = AlchemicalStage.VIRIDITAS\n        else:\n            self.alchemical_stage = AlchemicalStage.TRANSCENDENT\n    \n    def _derive_z_reactivity(self) -> None:\n        \"\"\"\n        Tree luminosity and fire intensity respond to Z-score.\n        \n        Tree (Yggdrasil/Male):  Glows brighter with higher Z\n        Fire (Hearth/Female):   Burns stronger with lower Z (refuge)\n        \"\"\"\n        z_norm = min(12.0, max(0.0, self.z_score)) / 12.0  # Normalize to 0-1\n        \n        # Tree luminosity (0 at crisis, 1 at transcendent)\n        self.tree_luminosity = z_norm\n        \n        # Fire intensity (inverse - 1 at crisis, 0 at transcendent)\n        self.fire_intensity = 1.0 - z_norm\n        \n        # Crisis override\n        if self.z_score < 2.0:\n            self.z_override = True\n            # Ensure crisis is visible regardless of weather\n            self.light_intensity = min(self.light_intensity, 0.3)\n            self.tree_luminosity = 0.1  # Dim glow\n            self.fire_intensity = 0.9   # Strong fire (refuge)\n        \n        # Transcendent override\n        if self.z_score >= 10.0:\n            self.z_override = True\n            self.tree_luminosity = 1.0\n            self.particle_type = ParticleEffect.AURORA\n    \n    def _derive_sky_color(self) -> None:\n        \"\"\"Calculate sky gradient based on time and weather.\"\"\"\n        # Base colors by time of day\n        phase = self.time_of_day\n        \n        if phase == TimePhase.DAWN:\n            top, bottom = \"#FF6B6B\", \"#FFE66D\"\n        elif phase == TimePhase.MORNING:\n            top, bottom = \"#87CEEB\", \"#FFA07A\"\n        elif phase == TimePhase.AFTERNOON:\n            top, bottom = \"#1E90FF\", \"#87CEEB\"\n        elif phase == TimePhase.DUSK:\n            top, bottom = \"#FF6347\", \"#FFD700\"\n        elif phase == TimePhase.NIGHT:\n            top, bottom = \"#191970\", \"#4B0082\"\n        else:  # DEEP_NIGHT\n            top, bottom = \"#000000\", \"#191970\"\n        \n        # Weather modifications\n        if self.condition in [WeatherCondition.CLOUDY, WeatherCondition.FOG]:\n            top = \"#808080\"\n            bottom = \"#A9A9A9\"\n        elif self.condition in [WeatherCondition.STORM, WeatherCondition.HEAVY_RAIN]:\n            top = \"#2F4F4F\"\n            bottom = \"#696969\"\n        \n        self.sky_color = RGBGradient(top=top, bottom=bottom)\n    \n    def _derive_light_intensity(self) -> None:\n        \"\"\"Calculate overall light level (0-1).\"\"\"\n        # Base from solar angle\n        if self.solar_angle < 0:\n            base = max(0.1, (self.solar_angle + 18) / 18 * 0.3)  # Night\n        else:\n            base = min(1.0, 0.3 + self.solar_angle / 90 * 0.7)  # Day\n        \n        # Weather attenuation\n        if self.condition == WeatherCondition.CLOUDY:\n            base *= 0.7\n        elif self.condition == WeatherCondition.FOG:\n            base *= 0.5\n        elif self.condition in [WeatherCondition.STORM, WeatherCondition.HEAVY_RAIN]:\n            base *= 0.4\n        \n        self.light_intensity = base\n    \n    def _derive_fog_density(self) -> None:\n        \"\"\"Calculate fog/haze density (0-1).\"\"\"\n        if self.condition == WeatherCondition.FOG:\n            self.fog_density = 0.8\n        elif self.condition == WeatherCondition.CLOUDY:\n            self.fog_density = 0.3\n        elif self.humidity > 0.8:\n            self.fog_density = 0.2\n        else:\n            self.fog_density = 0.0\n    \n    def _derive_particle_effects(self) -> None:\n        \"\"\"Determine which particle system to display.\"\"\"\n        # Weather overrides Z-score for particles (Factor 13: honest reflection)\n        if self.condition == WeatherCondition.RAIN:\n            self.particle_type = ParticleEffect.RAIN\n        elif self.condition == WeatherCondition.HEAVY_RAIN:\n            self.particle_type = ParticleEffect.RAIN\n        elif self.condition == WeatherCondition.SNOW:\n            self.particle_type = ParticleEffect.SNOW\n        elif self.season == Season.AUTUMN and self.condition == WeatherCondition.CLEAR:\n            self.particle_type = ParticleEffect.LEAVES\n        elif self.season == Season.SPRING and self.condition == WeatherCondition.CLEAR:\n            self.particle_type = ParticleEffect.PETALS\n        elif self.time_of_day == TimePhase.NIGHT and self.season == Season.SUMMER:\n            self.particle_type = ParticleEffect.FIREFLIES\n        elif self.z_score >= 10.0:\n            self.particle_type = ParticleEffect.AURORA\n        else:\n            self.particle_type = ParticleEffect.NONE\n    \n    def _derive_ambient_sound(self) -> None:\n        \"\"\"Select ambient audio track.\"\"\"\n        # Weather sounds take priority\n        if self.condition == WeatherCondition.STORM:\n            self.ambient_sound = SoundscapeID.THUNDER\n        elif self.condition == WeatherCondition.HEAVY_RAIN:\n            self.ambient_sound = SoundscapeID.RAIN_HEAVY\n        elif self.condition == WeatherCondition.RAIN:\n            self.ambient_sound = SoundscapeID.RAIN_LIGHT\n        elif self.condition == WeatherCondition.FOG:\n            self.ambient_sound = SoundscapeID.SILENCE\n        # Time-based sounds\n        elif self.time_of_day in [TimePhase.MORNING, TimePhase.AFTERNOON]:\n            self.ambient_sound = SoundscapeID.FOREST_DAY\n        elif self.time_of_day == TimePhase.NIGHT:\n            if self.season == Season.SUMMER:\n                self.ambient_sound = SoundscapeID.CRICKETS\n            else:\n                self.ambient_sound = SoundscapeID.FOREST_NIGHT\n        elif self.time_of_day in [TimePhase.DAWN, TimePhase.DUSK]:\n            self.ambient_sound = SoundscapeID.BIRDSONG\n        elif self.z_score >= 10.0:\n            self.ambient_sound = SoundscapeID.AURORA_HUM\n        else:\n            self.ambient_sound = SoundscapeID.SILENCE\n    \n    def to_dict(self) -> dict:\n        \"\"\"Serialize to JSON-compatible dict.\"\"\"\n        d = asdict(self)\n        d[\"timestamp\"] = self.timestamp.isoformat()\n        d[\"time_of_day\"] = self.time_of_day.value\n        d[\"season\"] = self.season.value\n        d[\"condition\"] = self.condition.value\n        d[\"alchemical_stage\"] = self.alchemical_stage.value\n        d[\"ambient_sound\"] = self.ambient_sound.value\n        d[\"particle_type\"] = self.particle_type.value\n        if self.sky_color:\n            d[\"sky_color\"] = asdict(self.sky_color)\n        return d\n