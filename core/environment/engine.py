"""\nLIVING ENVIRONMENT ENGINE - MAIN ORCHESTRATOR\nCombines astronomy, weather, and Z-score into unified EnvironmentState.\n\nEvidence Grade: E3 (System integration of E5 inputs)\n"""\n\nfrom __future__ import annotations\nimport logging\nfrom datetime import datetime, timezone\nfrom typing import Optional\n\nfrom core.environment.state import EnvironmentState\nfrom core.environment.types import TimePhase\nfrom core.environment.astronomy import AstronomyCalculator\nfrom core.environment.weather import OpenWeatherMapClient, WeatherData\n\nlogger = logging.getLogger(__name__)\n\n# ---------------------------------------------------------------------------\n# Mock Z-Score Stream (Placeholder)\n# ---------------------------------------------------------------------------\n\nclass ZScoreStream:\n    \"\"\"\n    Mock Z-score stream for testing.\n    \n    In production, this will be replaced with real Core plane integration:\n    from core.zscore.stream import RealZScoreStream\n    \"\"\"\n    \n    def __init__(self) -> None:\n        self._z = 7.0  # Default to healthy state\n    \n    def current(self) -> float:\n        \"\"\"Get current Z-score.\"\"\"\n        return self._z\n    \n    def update(self, coherence: float, fidelity: float, balance: float) -> None:\n        \"\"\"Update Z-score (for testing).\"\"\"\n        self._z = 12 * (coherence * fidelity * balance) ** 0.5\n        logger.info(f\"Z-score updated: {self._z:.2f}\")\n\n# ---------------------------------------------------------------------------\n# Living Environment Engine\n# ---------------------------------------------------------------------------\n\nclass LivingEnvironmentEngine:\n    \"\"\"\n    Main orchestrator for LEE.\n    \n    Combines four simultaneous data streams:\n    1. Astronomical cycles (AstronomyCalculator)\n    2. Seasonal transformation (GPS-based)\n    3. Live weather (OpenWeatherMapClient)\n    4. Z-score override (ZScoreStream)\n    \n    Usage::\n        engine = LivingEnvironmentEngine(weather_api_key=\"your_key\")\n        state = engine.get_state(lat=29.4241, lon=-98.4936)\n        print(state.to_dict())\n    \"\"\"\n    \n    def __init__(\n        self,\n        weather_api_key: Optional[str] = None,\n        weather_update_interval: int = 900,  # 15 minutes\n    ) -> None:\n        self.astronomy = AstronomyCalculator()\n        self.weather_client = OpenWeatherMapClient(\n            api_key=weather_api_key,\n            update_interval_seconds=weather_update_interval,\n        )\n        self.z_stream = ZScoreStream()\n        \n        logger.info(\"LivingEnvironmentEngine initialized\")\n    \n    def get_state(\n        self,\n        lat: float,\n        lon: float,\n        utc_now: Optional[datetime] = None,\n    ) -> EnvironmentState:\n        \"\"\"\n        Generate complete EnvironmentState for given location and time.\n        \n        Args:\n            lat: Latitude (-90 to 90)\n            lon: Longitude (-180 to 180)\n            utc_now: Current UTC time (defaults to datetime.now(timezone.utc))\n        \n        Returns:\n            EnvironmentState with all derived rendering parameters\n        \"\"\"\n        if utc_now is None:\n            utc_now = datetime.now(timezone.utc)\n        \n        # 1. Astronomy\n        solar = self.astronomy.solar_position(lat, lon, utc_now)\n        season = self.astronomy.season(lat, utc_now)\n        \n        # 2. Weather\n        weather = self.weather_client.current(lat, lon)\n        \n        # 3. Z-score\n        z = self.z_stream.current()\n        \n        # 4. Construct state\n        state = EnvironmentState(\n            timestamp=utc_now,\n            time_of_day=solar[\"phase\"],\n            solar_angle=solar[\"altitude\"],\n            season=season,\n            condition=weather.condition,\n            z_score=z,\n            temperature_c=weather.temperature_c,\n            humidity=weather.humidity,\n            wind_speed_ms=weather.wind_speed_ms,\n            uv_index=weather.uv_index,\n        )\n        \n        logger.debug(f\"EnvironmentState generated: Z={z:.2f}, phase={solar['phase'].value}, condition={weather.condition.value}\")\n        \n        return state\n