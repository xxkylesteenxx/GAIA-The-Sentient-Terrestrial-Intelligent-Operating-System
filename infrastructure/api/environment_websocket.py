"""\nLIVING ENVIRONMENT ENGINE - WEBSOCKET API\nStreams EnvironmentState to frontend renderers every 15 seconds.\n\nWebSocket endpoint: ws://localhost:8767/environment\n\nMessage format::\n    {\n        \"type\": \"environment_state\",\n        \"timestamp\": \"2026-02-28T19:00:00Z\",\n        \"state\": { ... EnvironmentState.to_dict() ... }\n    }\n\nUsage::\n    python -m infrastructure.api.environment_websocket\n\nEvidence Grade: E3 (Infrastructure for E5 data delivery)\n"""\n\nimport asyncio\nimport json\nimport logging\nimport os\nfrom datetime import datetime, timezone\nfrom typing import Set\n\nimport websockets\nfrom websockets.server import WebSocketServerProtocol\n\nfrom core.environment import LivingEnvironmentEngine\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"[LEE] %(asctime)s - %(levelname)s - %(message)s\"\n)\nlogger = logging.getLogger(__name__)\n\n# ---------------------------------------------------------------------------\n# WebSocket Server\n# ---------------------------------------------------------------------------\n\nclass EnvironmentWebSocket:\n    \"\"\"\n    WebSocket server that broadcasts EnvironmentState to all connected clients.\n    \"\"\"\n    \n    def __init__(\n        self,\n        host: str = \"0.0.0.0\",\n        port: int = 8767,\n        update_interval: int = 15,  # seconds\n        default_lat: float = 29.4241,  # San Antonio, TX\n        default_lon: float = -98.4936,\n    ) -> None:\n        self.host = host\n        self.port = port\n        self.update_interval = update_interval\n        self.default_lat = default_lat\n        self.default_lon = default_lon\n        \n        # Initialize LEE\n        api_key = os.getenv(\"OPENWEATHERMAP_API_KEY\")\n        self.engine = LivingEnvironmentEngine(weather_api_key=api_key)\n        \n        # Connected clients\n        self.clients: Set[WebSocketServerProtocol] = set()\n        \n        logger.info(f\"EnvironmentWebSocket initialized on {host}:{port}\")\n    \n    async def register(self, websocket: WebSocketServerProtocol) -> None:\n        \"\"\"Register new client connection.\"\"\"\n        self.clients.add(websocket)\n        logger.info(f\"Client connected. Total clients: {len(self.clients)}\")\n    \n    async def unregister(self, websocket: WebSocketServerProtocol) -> None:\n        \"\"\"Unregister disconnected client.\"\"\"\n        self.clients.discard(websocket)\n        logger.info(f\"Client disconnected. Total clients: {len(self.clients)}\")\n    \n    async def handler(self, websocket: WebSocketServerProtocol, path: str) -> None:\n        \"\"\"\n        Handle WebSocket connection.\n        \n        Clients receive initial state immediately, then updates every N seconds.\n        \"\"\"\n        await self.register(websocket)\n        \n        try:\n            # Send initial state immediately\n            state = self.engine.get_state(self.default_lat, self.default_lon)\n            message = {\n                \"type\": \"environment_state\",\n                \"timestamp\": datetime.now(timezone.utc).isoformat(),\n                \"state\": state.to_dict(),\n            }\n            await websocket.send(json.dumps(message))\n            logger.debug(\"Sent initial state to client\")\n            \n            # Keep connection open and wait for disconnect\n            await websocket.wait_closed()\n        \n        finally:\n            await self.unregister(websocket)\n    \n    async def broadcast_loop(self) -> None:\n        \"\"\"\n        Periodically generate new EnvironmentState and broadcast to all clients.\n        \"\"\"\n        while True:\n            await asyncio.sleep(self.update_interval)\n            \n            if not self.clients:\n                logger.debug(\"No clients connected, skipping broadcast\")\n                continue\n            \n            # Generate fresh state\n            state = self.engine.get_state(self.default_lat, self.default_lon)\n            message = {\n                \"type\": \"environment_state\",\n                \"timestamp\": datetime.now(timezone.utc).isoformat(),\n                \"state\": state.to_dict(),\n            }\n            \n            # Broadcast to all clients\n            message_json = json.dumps(message)\n            logger.info(f\"Broadcasting state to {len(self.clients)} clients (Z={state.z_score:.2f})\")\n            \n            # Send to all clients (handle disconnections)\n            disconnected = set()\n            for client in self.clients:\n                try:\n                    await client.send(message_json)\n                except Exception as e:\n                    logger.error(f\"Error sending to client: {e}\")\n                    disconnected.add(client)\n            \n            # Clean up disconnected clients\n            for client in disconnected:\n                await self.unregister(client)\n    \n    async def start(self) -> None:\n        \"\"\"Start WebSocket server and broadcast loop.\"\"\"\n        logger.info(f\"Starting EnvironmentWebSocket on {self.host}:{self.port}\")\n        logger.info(f\"Update interval: {self.update_interval}s\")\n        logger.info(f\"Default location: ({self.default_lat}, {self.default_lon})\")\n        \n        # Start WebSocket server\n        async with websockets.serve(self.handler, self.host, self.port):\n            logger.info(\"WebSocket server listening...\")\n            # Start broadcast loop\n            await self.broadcast_loop()\n\n# ---------------------------------------------------------------------------\n# Main\n# ---------------------------------------------------------------------------\n\ndef main() -> None:\n    \"\"\"Run WebSocket server.\"\"\"\n    # Configuration from environment variables\n    host = os.getenv(\"LEE_HOST\", \"0.0.0.0\")\n    port = int(os.getenv(\"LEE_PORT\", \"8767\"))\n    interval = int(os.getenv(\"LEE_UPDATE_INTERVAL\", \"15\"))\n    lat = float(os.getenv(\"LEE_LAT\", \"29.4241\"))\n    lon = float(os.getenv(\"LEE_LON\", \"-98.4936\"))\n    \n    # Create and start server\n    server = EnvironmentWebSocket(\n        host=host,\n        port=port,\n        update_interval=interval,\n        default_lat=lat,\n        default_lon=lon,\n    )\n    \n    # Run\n    try:\n        asyncio.run(server.start())\n    except KeyboardInterrupt:\n        logger.info(\"Server stopped by user\")\n\nif __name__ == \"__main__\":\n    main()\n